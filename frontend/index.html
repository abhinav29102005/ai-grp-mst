<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cloud Resource Allocation Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --bg: #ffffff; --card: #f8fafb; --sidebar: #0f172a;
            --accent: #00d9ff; --accent-dark: #0099cc; --text: #0f172a; --muted: #64748b;
            --border: #e2e8f0; --green: #00ff88; --blue: #0088ff; --purple: #d946ef;
            --orange: #ff8800; --red: #ff4444; --pink: #ff0099;
        }
        body.dark-mode {
            --bg: #0a0e27; --card: #1a1f3a; --sidebar: #000814;
            --text: #e0e0e0; --border: #333344; --muted: #8090a0;
        }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: var(--bg); color: var(--text); display: flex; min-height: 100vh; transition: background .3s, color .3s; }

        /* Sidebar */
        .sidebar { width: 220px; background: linear-gradient(135deg, var(--sidebar) 0%, #1a1f3a 100%); color: #fff; padding: 24px 0; position: fixed; top: 0; left: 0; bottom: 0; overflow-y: auto; box-shadow: 2px 0 12px rgba(0,217,255,.15); }
        .sidebar h2 { font-size: 15px; padding: 0 20px; margin-bottom: 6px; font-weight: 600; }
        .sidebar p { font-size: 11px; color: #8eafc4; padding: 0 20px; margin-bottom: 24px; }
        .nav-btn { display: block; width: 100%; text-align: left; background: none; border: none; color: #7090c0; padding: 10px 20px; font-size: 13px; cursor: pointer; transition: all .15s; }
        .nav-btn:hover { background: rgba(0,217,255,.15); color: #00d9ff; }
        .nav-btn.active { background: rgba(0,217,255,.2); color: #00d9ff; border-left: 3px solid var(--accent); font-weight: 600; }
        .theme-toggle { position: absolute; top: 20px; right: 20px; background: rgba(0,217,255,.1); border: 1px solid var(--accent); color: var(--accent); padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600; transition: all .2s; }
        .theme-toggle:hover { background: rgba(0,217,255,.2); }
        .sidebar-footer { position: absolute; bottom: 16px; padding: 0 20px; font-size: 10px; color: #475569; }

        /* Main */
        .main { margin-left: 220px; flex: 1; padding: 28px 32px; }
        .page { display: none; } .page.active { display: block; }
        .page h1 { font-size: 22px; margin-bottom: 20px; }

        /* Cards */
        .card { background: var(--card); border-radius: 12px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,217,255,.08); border: 1px solid var(--border); }
        .metrics { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 14px; margin-bottom: 20px; }
        .metric { background: linear-gradient(135deg, var(--card) 0%, rgba(0,217,255,.05) 100%); border-radius: 12px; padding: 16px; border-left: 4px solid; border-left-color: var(--accent); box-shadow: 0 2px 6px rgba(0,217,255,.08); border: 1px solid var(--border); }
        .metric-accuracy { background: linear-gradient(135deg, var(--green) 0%, rgba(0,255,136,.1) 100%); border-left-color: var(--green) !important; }
        .metric-accuracy .metric-value { color: var(--green); font-weight: 800; }
        .metric-accuracy .metric-label { color: #00cc66; font-weight: 700; }
        .metric-label { font-size: 11px; color: var(--muted); text-transform: uppercase; letter-spacing: .5px; }
        .metric-value { font-size: 22px; font-weight: 700; margin-top: 4px; }
        .metric-sub { font-size: 11px; color: var(--muted); margin-top: 2px; }

        /* Table */
        table { width: 100%; border-collapse: collapse; font-size: 13px; }
        th { background: rgba(0,217,255,.05); text-align: left; padding: 10px 12px; font-weight: 600; font-size: 11px; text-transform: uppercase; color: var(--muted); border-bottom: 2px solid rgba(0,217,255,.2); }
        td { padding: 10px 12px; border-bottom: 1px solid var(--border); color: var(--text); }

        /* Loading */
        .loading { position: fixed; inset: 0; background: rgba(255,255,255,.85); display: flex; align-items: center; justify-content: center; z-index: 999; }
        .loading.hidden { display: none; }
        .spinner { width: 36px; height: 36px; border: 3px solid var(--border); border-top-color: var(--sidebar); border-radius: 50%; animation: spin .7s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .status { position: fixed; top: 12px; right: 16px; font-size: 11px; padding: 6px 12px; border-radius: 6px; z-index: 1000; font-weight: 500; }
        .status.ok { background: rgba(0,255,136,.15); color: var(--green); border: 1px solid rgba(0,255,136,.4); }
        .status.err { background: rgba(255,68,68,.15); color: var(--red); border: 1px solid rgba(255,68,68,.4); }

        @media (max-width: 768px) {
            .sidebar { width: 100%; position: relative; }
            .main { margin-left: 0; }
            body { flex-direction: column; }
        }
    </style>
</head>
<body>
    <button class="theme-toggle" onclick="document.body.classList.toggle('dark-mode'); localStorage.setItem('theme', document.body.classList.contains('dark-mode') ? 'dark' : 'light')">ðŸŒ™ Dark Mode</button>
    <nav class="sidebar">
        <h2>Cloud Resource Allocation</h2>
        <p>ML Clustering Dashboard</p>
        <button class="nav-btn active" data-page="overview">Overview</button>
        <button class="nav-btn" data-page="outliers">Outliers</button>
        <button class="nav-btn" data-page="correlation">Correlation</button>
        <button class="nav-btn" data-page="elbow">Elbow Method</button>
        <button class="nav-btn" data-page="clustering">Clustering</button>
        <button class="nav-btn" data-page="explorer">Cluster Explorer</button>
        <button class="nav-btn" data-page="tsne">t-SNE</button>
        <div class="sidebar-footer">Group 23 - AIML Project</div>
    </nav>

    <div class="main">
        <div id="loading" class="loading"><div class="spinner"></div></div>
        <div id="status" class="status"></div>

        <div id="page-overview" class="page active">
            <h1>Dataset Overview</h1>
            <div id="ov-metrics" class="metrics"></div>
            <div class="card">
                <h3>Feature Statistics</h3>
                <div id="ov-table"></div>
            </div>
            <div class="card">
                <h3>Feature Distributions</h3>
                <label style="margin-bottom: 10px; display: block;">
                    Select Feature: <select id="ov-feature-select" style="padding: 6px; border-radius: 4px; border: 1px solid var(--border);"></select>
                </label>
                <div id="ov-hist"></div>
            </div>
        </div>

        <div id="page-outliers" class="page">
            <h1>Outlier Analysis (IQR Method)</h1>
            <div id="out-metric" class="metrics"></div>
            <div class="card">
                <h3>Outlier Distribution by Feature</h3>
                <div id="out-chart"></div>
            </div>
            <div class="card">
                <h3>Outlier Details</h3>
                <div id="out-table"></div>
            </div>
        </div>

        <div id="page-correlation" class="page">
            <h1>Feature Correlation Matrix</h1>
            <div class="card">
                <div id="corr-chart"></div>
            </div>
        </div>

        <div id="page-elbow" class="page">
            <h1>Elbow Method - Optimal K Selection</h1>
            <div class="card">
                <div id="elbow-chart"></div>
            </div>
            <div class="card">
                <h3>Elbow Data Details</h3>
                <div id="elbow-table"></div>
            </div>
        </div>

        <div id="page-clustering" class="page">
            <h1>KMeans Clustering Results</h1>
            <div id="cl-metrics" class="metrics"></div>
            <div class="card">
                <h3>Cluster Centroids</h3>
                <div id="cl-table"></div>
            </div>
            <div class="card">
                <h3>Cluster Comparison</h3>
                <div id="cl-chart"></div>
            </div>
        </div>

        <div id="page-explorer" class="page">
            <h1>Cluster Data Explorer</h1>
            <div class="card">
                <div style="margin-bottom: 16px;">
                    <label style="margin-right: 20px;">
                        X Axis: <select id="ex-x" style="padding: 6px; border-radius: 4px; border: 1px solid var(--border);"></select>
                    </label>
                    <label>
                        Y Axis: <select id="ex-y" style="padding: 6px; border-radius: 4px; border: 1px solid var(--border);"></select>
                    </label>
                </div>
                <div id="ex-chart"></div>
            </div>
            <div class="card">
                <h3>Filtered Data</h3>
                <div style="margin-bottom: 12px;">
                    <label>Filter by Cluster: 
                        <div id="cluster-filters" style="display: inline-block; margin-left: 8px;"></div>
                    </label>
                </div>
                <div id="ex-table" style="max-height: 500px; overflow-y: auto;"></div>
            </div>
        </div>

        <div id="page-tsne" class="page">
            <h1>t-SNE Dimensionality Reduction</h1>
            <div class="card">
                <div id="tsne-chart"></div>
            </div>
            <div class="card">
                <h3>t-SNE Data Sample</h3>
                <div id="tsne-table"></div>
            </div>
        </div>
    </div>

<script>
const SUPABASE_URL = "https://ltgghjqptfokkidbiaif.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx0Z2doanFwdGZva2tpZGJpYWlmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE5MjM2ODgsImV4cCI6MjA4NzQ5OTY4OH0.VUVXG33fT8rlBdHwuyzqsCKnQeK21Bd92namuMdRWFY";
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
const COLORS = ["#00d9ff","#0088ff","#d946ef","#ff0099","#ff8800","#00ff88"];
const layout = { 
    font:{family:"-apple-system,sans-serif",size:12,color:"var(--text)"}, 
    paper_bgcolor:"transparent", 
    plot_bgcolor:"transparent",
    xaxis:{showgrid:true,gridwidth:1,gridcolor:"rgba(100,116,139,.1)",zeroline:false},
    yaxis:{showgrid:true,gridwidth:1,gridcolor:"rgba(100,116,139,.1)",zeroline:false},
    margin:{l:50,r:20,t:40,b:40} 
};

/* Nav */
document.querySelectorAll(".nav-btn").forEach(b => b.addEventListener("click", () => {
    document.querySelectorAll(".nav-btn").forEach(n => n.classList.remove("active"));
    b.classList.add("active");
    document.querySelectorAll(".page").forEach(p => p.classList.remove("active"));
    document.getElementById("page-" + b.dataset.page).classList.add("active");
}));

function fmt(n) { return typeof n === "number" ? n.toLocaleString(undefined,{maximumFractionDigits:2}) : n; }
function title(s) { return s.replace(/_/g," ").replace(/\b\w/g,c=>c.toUpperCase()); }

async function fetchAll(table) {
    let rows = [], from = 0, size = 1000;
    while (true) {
        const {data,error} = await sb.from(table).select("*").range(from, from+size-1);
        if (error) throw error;
        rows.push(...data);
        if (data.length < size) break;
        from += size;
    }
    return rows;
}

async function init() {
    // Restore theme preference
    const savedTheme = localStorage.getItem('theme');
    if (savedTheme === 'dark') document.body.classList.add('dark-mode');
    
    try {
        const [stats, outliers, corr, elbow, summary, clustered, tsne] = await Promise.all([
            fetchAll("data_stats"), fetchAll("outlier_counts"), fetchAll("correlation_data"),
            fetchAll("elbow_data"), fetchAll("cluster_summary"), fetchAll("clustered_data"), fetchAll("tsne_data")
        ]);

        console.log("Data loaded:", {stats: stats.length, outliers: outliers.length, corr: corr.length, elbow: elbow.length, summary: summary.length, clustered: clustered.length, tsne: tsne.length});

        document.getElementById("status").textContent = "âœ“ Connected";
        document.getElementById("status").className = "status ok";

        const totalRows = clustered.length;
        const numCols = Object.keys(clustered[0] || {}).filter(c => !["id","created_at","cluster_id"].includes(c));

        /* Overview */
        if (stats.length) {
            let mh = '';
            stats.forEach(s => { 
                mh += `<div class="metric"><div class="metric-label">${title(s.feature_name)}</div><div class="metric-value">${fmt(s.mean_val)}</div><div class="metric-sub">Std: ${fmt(s.std_val)}</div></div>`; 
            });
            document.getElementById("ov-metrics").innerHTML = mh;
            
            let th = "<table><thead><tr><th>Feature</th><th>Mean</th><th>Std</th><th>Min</th><th>Max</th><th>Median</th><th>Rows</th></tr></thead><tbody>";
            stats.forEach(s => { th += `<tr><td><strong>${title(s.feature_name)}</strong></td><td>${fmt(s.mean_val)}</td><td>${fmt(s.std_val)}</td><td>${fmt(s.min_val)}</td><td>${fmt(s.max_val)}</td><td>${fmt(s.median_val)}</td><td>${s.row_count}</td></tr>`; });
            document.getElementById("ov-table").innerHTML = th + "</tbody></table>";
        }
        
        // Feature distribution selector
        if (clustered.length && numCols.length) {
            const sel = document.getElementById("ov-feature-select");
            numCols.forEach((c,i) => { sel.add(new Option(title(c), c, i===0)); });
            function plotHist() {
                const col = sel.value;
                const vals = clustered.map(r => r[col]);
                Plotly.newPlot("ov-hist", [{
                    x:vals, type:"histogram", nbinsx:40,
                    marker:{color:COLORS[0],line:{color:COLORS[1],width:1}},
                    name:title(col)
                }], {...layout, title:title(col)+" Distribution", xaxis:{title:title(col)}, yaxis:{title:"Count"}}, {responsive:true});
            }
            sel.onchange = plotHist;
            plotHist();
        }

        /* Outliers */
        if (outliers.length) {
            const total = outliers.reduce((s,o) => s+o.outlier_count, 0);
            document.getElementById("out-metric").innerHTML = `<div class="metric" style="border-left-color:${COLORS[4]}"><div class="metric-label">Total Outliers</div><div class="metric-value">${total}</div><div class="metric-sub">IQR Method</div></div>`;
            
            const colors = outliers.map(o=>o.outlier_count>20?COLORS[4]:o.outlier_count>0?COLORS[3]:COLORS[2]);
            Plotly.newPlot("out-chart", [{
                x:outliers.map(o=>title(o.feature_name)),
                y:outliers.map(o=>o.outlier_count),
                type:"bar",
                marker:{color:colors,line:{color:"rgba(0,0,0,0.2)",width:1}},
                text:outliers.map(o=>o.outlier_count),
                textposition:"outside",
                hovertemplate:"<b>%{x}</b><br>Outliers: %{y}<extra></extra>"
            }], {...layout, title:"Outlier Count by Feature", xaxis:{title:"Feature"}, yaxis:{title:"Number of Outliers"}, height:400}, {responsive:true});
            
            let th = "<table><thead><tr><th>Feature</th><th>Outlier Count</th><th>Status</th></tr></thead><tbody>";
            outliers.forEach(o => { 
                const status = o.outlier_count > 20 ? "âš ï¸ High" : o.outlier_count > 0 ? "âš¡ Some" : "âœ“ Clean"; 
                th += `<tr><td><strong>${title(o.feature_name)}</strong></td><td><strong style="color:${o.outlier_count>20?'var(--red)':o.outlier_count>0?'var(--orange)':'var(--green)'}">${o.outlier_count}</strong></td><td>${status}</td></tr>`; 
            });
            document.getElementById("out-table").innerHTML = th + "</tbody></table>";
        }

        /* Correlation */
        if (corr.length) {
            try {
                const cols = JSON.parse(corr[0].columns_list), mat = JSON.parse(corr[0].matrix_data);
                const labels = cols.map(c => title(c));
                const text = mat.map(row => row.map(v => v.toFixed(2)));
                Plotly.newPlot("corr-chart", [{
                    z:mat, x:labels, y:labels, type:"heatmap",
                    colorscale:"RdBu", reversescale:true, zmin:-1, zmax:1,
                    text:text, texttemplate:"%{text}", textfont:{size:10},
                    hovertemplate:"<b>%{y} vs %{x}</b><br>Correlation: %{z:.3f}<extra></extra>"
                }], {...layout, height:600, title:"Feature Correlation Heatmap", xaxis:{tickangle:-45}}, {responsive:true});
            } catch(e) {
                console.error("Correlation error:", e);
                document.getElementById("corr-chart").innerHTML = `<div style="padding:20px;color:var(--red)">Error loading correlation: ${e.message}</div>`;
            }
        } else {
            document.getElementById("corr-chart").innerHTML = `<div style="padding:20px;color:var(--muted)">No correlation data available</div>`;
        }

        /* Elbow */
        if (elbow.length) {
            const sorted = elbow.sort((a,b) => a.k - b.k);
            Plotly.newPlot("elbow-chart", [{
                x:sorted.map(e=>e.k), y:sorted.map(e=>e.inertia),
                type:"scatter", mode:"lines+markers",
                marker:{color:COLORS[0],size:10,line:{color:COLORS[1],width:2}},
                line:{color:COLORS[0],width:3},
                hovertemplate:"<b>K=%{x}</b><br>Inertia: %{y:.0f}<extra></extra>"
            }], {...layout, title:"Elbow Method - Optimal K Selection", xaxis:{title:"Number of Clusters (K)",tickmode:"linear"}, yaxis:{title:"Inertia (WCSS)"}, height:450}, {responsive:true});
            
            let th = "<table><thead><tr><th>K</th><th>Inertia</th><th>Reduction from Previous</th></tr></thead><tbody>";
            sorted.forEach((e,i) => { 
                const reduction = i > 0 ? (((sorted[i-1].inertia - e.inertia) / sorted[i-1].inertia * 100).toFixed(1) + "%") : "â€”"; 
                th += `<tr><td><strong>${e.k}</strong></td><td>${fmt(e.inertia)}</td><td>${reduction}</td></tr>`; 
            });
            document.getElementById("elbow-table").innerHTML = th + "</tbody></table>";
        }

        /* Clustering */
        if (summary.length) {
            try {
                const sorted = summary.sort((a,b) => a.cluster_id - b.cluster_id);
                let mh = '';
                sorted.forEach(s => { 
                    const pct = totalRows > 0 ? (s.record_count/totalRows*100).toFixed(1) : 0;
                    mh += `<div class="metric" style="border-left-color:${COLORS[s.cluster_id%COLORS.length]}"><div class="metric-label">Cluster ${s.cluster_id}</div><div class="metric-value">${s.record_count}</div><div class="metric-sub">${pct}% of data</div></div>`; 
                });
                document.getElementById("cl-metrics").innerHTML = mh;
                
                const meanCols = Object.keys(sorted[0]).filter(c => c.endsWith("_mean"));
                if (meanCols.length > 0) {
                    let th = "<table><thead><tr><th>Cluster</th>" + meanCols.map(c => `<th>${title(c.replace("_mean",""))}</th>`).join("") + "<th>Count</th></tr></thead><tbody>";
                    sorted.forEach(s => { 
                        th += `<tr><td><strong style="color:${COLORS[s.cluster_id%COLORS.length]}">Cluster ${s.cluster_id}</strong></td>` + meanCols.map(c => `<td>${fmt(s[c])}</td>`).join("") + `<td><strong>${s.record_count}</strong></td></tr>`; 
                    });
                    document.getElementById("cl-table").innerHTML = th + "</tbody></table>";
                    
                    const traces = sorted.map(s => ({
                        name:`Cluster ${s.cluster_id}`,
                        x:meanCols.map(c=>title(c.replace("_mean",""))),
                        y:meanCols.map(c=>s[c]),
                        type:"bar",
                        marker:{color:COLORS[s.cluster_id%COLORS.length],line:{color:COLORS[(s.cluster_id+1)%COLORS.length],width:1}},
                        hovertemplate:"<b>Cluster "+s.cluster_id+"</b><br>%{x}: %{y:.2f}<extra></extra>"
                    }));
                    Plotly.newPlot("cl-chart", traces, {...layout, title:"Cluster Centroids Comparison", barmode:"group", yaxis:{title:"Mean Feature Value"}, height:450}, {responsive:true});
                } else {
                    document.getElementById("cl-table").innerHTML = `<div style="padding:20px;color:var(--muted)">No mean columns found in cluster summary</div>`;
                    document.getElementById("cl-chart").innerHTML = `<div style="padding:20px;color:var(--muted)">No clustering data to display</div>`;
                }
            } catch(e) {
                console.error("Clustering error:", e);
                document.getElementById("cl-metrics").innerHTML = `<div style="padding:20px;color:var(--red)">Error loading clustering metrics: ${e.message}</div>`;
                document.getElementById("cl-table").innerHTML = `<div style="padding:20px;color:var(--red)">Error loading clustering table: ${e.message}</div>`;
            }
        } else {
            document.getElementById("cl-metrics").innerHTML = `<div style="padding:20px;color:var(--muted)">No cluster summary data available</div>`;
            document.getElementById("cl-table").innerHTML = `<div style="padding:20px;color:var(--muted)">No clustering data available</div>`;
        }

        /* Explorer */
        if (clustered.length && numCols.length) {
            const selX = document.getElementById("ex-x"), selY = document.getElementById("ex-y");
            numCols.forEach((c,i) => { 
                selX.add(new Option(title(c), c, i===0)); 
                selY.add(new Option(title(c), c, i===Math.min(1,numCols.length-1))); 
            });
            selY.selectedIndex = Math.min(1, numCols.length-1);
            
            const allClusters = [...new Set(clustered.map(r=>r.cluster_id))].sort();
            let selectedClusters = new Set(allClusters);
            
            // Create cluster filter checkboxes
            const filterDiv = document.getElementById("cluster-filters");
            allClusters.forEach(cid => {
                const label = document.createElement('label');
                label.style.marginRight = '15px';
                label.style.display = 'inline-block';
                const cb = document.createElement('input');
                cb.type = 'checkbox';
                cb.checked = true;
                cb.value = cid;
                cb.onchange = () => {
                    if (cb.checked) selectedClusters.add(cid);
                    else selectedClusters.delete(cid);
                    plotExplorer();
                    updateTable();
                };
                label.appendChild(cb);
                label.appendChild(document.createTextNode(` Cluster ${cid}`));
                filterDiv.appendChild(label);
            });
            
            function plotExplorer() {
                const xc = selX.value, yc = selY.value;
                const traces = allClusters.filter(cid => selectedClusters.has(cid)).map(cid => {
                    const pts = clustered.filter(r=>r.cluster_id===cid);
                    return {
                        x:pts.map(r=>r[xc]), y:pts.map(r=>r[yc]),
                        mode:"markers", type:"scatter", name:`Cluster ${cid}`,
                        marker:{color:COLORS[cid%COLORS.length],opacity:.7,size:5,line:{color:COLORS[(cid+1)%COLORS.length],width:0.5}},
                        hovertemplate:"<b>Cluster "+cid+"</b><br>"+title(xc)+": %{x:.2f}<br>"+title(yc)+": %{y:.2f}<extra></extra>"
                    };
                });
                Plotly.newPlot("ex-chart", traces, {...layout, title:"Interactive Cluster Explorer", xaxis:{title:title(xc)}, yaxis:{title:title(yc)}, height:500}, {responsive:true});
            }
            
            function updateTable() {
                const filtered = clustered.filter(r => selectedClusters.has(r.cluster_id));
                const displayCols = Object.keys(filtered[0] || {}).filter(c => !["id","created_at"].includes(c));
                let th = "<table><thead><tr>" + displayCols.map(c => `<th>${title(c)}</th>`).join("") + "</tr></thead><tbody>";
                filtered.slice(0, 200).forEach(r => {
                    th += "<tr>" + displayCols.map(c => {
                        const val = c === "cluster_id" ? `<strong style="color:${COLORS[r.cluster_id%COLORS.length]}">Cluster ${r[c]}</strong>` : fmt(r[c]);
                        return `<td>${val}</td>`;
                    }).join("") + "</tr>";
                });
                th += "</tbody></table>";
                th += `<div style="margin-top:8px;font-size:11px;color:var(--muted)">Showing ${Math.min(200, filtered.length)} of ${filtered.length} rows</div>`;
                document.getElementById("ex-table").innerHTML = th;
            }
            
            selX.onchange = plotExplorer; 
            selY.onchange = plotExplorer;
            plotExplorer();
            updateTable();
        }

        /* t-SNE */
        if (tsne.length) {
            const clusters = [...new Set(tsne.map(r=>r.cluster_id))].sort();
            const traces = clusters.map(cid => {
                const pts = tsne.filter(r=>r.cluster_id===cid);
                return {
                    x:pts.map(r=>r.x), y:pts.map(r=>r.y),
                    mode:"markers", type:"scatter", name:`Cluster ${cid}`,
                    marker:{color:COLORS[cid%COLORS.length],opacity:.75,size:4,line:{color:COLORS[(cid+1)%COLORS.length],width:0.5}},
                    hovertemplate:"<b>Cluster "+cid+"</b><br>t-SNE 1: %{x:.2f}<br>t-SNE 2: %{y:.2f}<extra></extra>"
                };
            });
            Plotly.newPlot("tsne-chart", traces, {...layout, title:"t-SNE Dimensionality Reduction", xaxis:{title:"t-SNE Dimension 1"}, yaxis:{title:"t-SNE Dimension 2"}, height:600}, {responsive:true});
            
            // t-SNE data table
            let th = "<table><thead><tr><th>t-SNE 1</th><th>t-SNE 2</th><th>Cluster</th></tr></thead><tbody>";
            tsne.slice(0, 100).forEach(r => {
                th += `<tr><td>${fmt(r.x)}</td><td>${fmt(r.y)}</td><td><strong style="color:${COLORS[r.cluster_id%COLORS.length]}">Cluster ${r.cluster_id}</strong></td></tr>`;
            });
            th += "</tbody></table>";
            th += `<div style="margin-top:8px;font-size:11px;color:var(--muted)">Showing first 100 of ${tsne.length} points</div>`;
            document.getElementById("tsne-table").innerHTML = th;
        }

    } catch(e) {
        document.getElementById("status").textContent = "Error: " + e.message;
        document.getElementById("status").className = "status err";
        console.error("Initialization error:", e);
    }
    document.getElementById("loading").classList.add("hidden");
}
init();
</script>
</body>
</html>